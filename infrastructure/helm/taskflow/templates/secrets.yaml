---
# SSO PostgreSQL Secret
# When using Neon: uses managed connection string
# When using in-cluster: builds URL from components
{{- if .Values.sso.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.sso.postgresql.name }}-secret
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "taskflow.componentLabels" (dict "root" . "component" "sso-db") | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.managedServices.neon.enabled }}
  # Neon managed PostgreSQL
  DATABASE_URL: {{ .Values.managedServices.neon.ssoDatabase | quote }}
  {{- else }}
  # In-cluster PostgreSQL
  POSTGRES_PASSWORD: {{ .Values.sso.postgresql.password | quote }}
  DATABASE_URL: "postgresql://{{ .Values.sso.database.user }}:{{ .Values.sso.postgresql.password }}@{{ .Values.sso.database.host }}:{{ .Values.sso.database.port }}/{{ .Values.sso.database.name }}?sslmode=disable"
  {{- end }}
{{- end }}

---
# SSO Platform Secret (Better Auth)
{{- if .Values.sso.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.sso.name }}-secret
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "taskflow.componentLabels" (dict "root" . "component" "sso") | nindent 4 }}
type: Opaque
stringData:
  BETTER_AUTH_SECRET: {{ .Values.sso.env.BETTER_AUTH_SECRET | quote }}
  # Password from values.yaml: sso.postgresql.password
  DATABASE_PASSWORD: {{ .Values.sso.postgresql.password | quote }}
  {{- if .Values.sso.smtp.enabled }}
  SMTP_PASS: {{ .Values.sso.smtp.password | quote }}
  {{- end }}
  {{- if .Values.managedServices.upstash.enabled }}
  # Upstash Redis REST API for rate limiting
  REDIS_URL: {{ .Values.managedServices.upstash.restUrl | quote }}
  REDIS_TOKEN: {{ .Values.managedServices.upstash.restToken | quote }}
  {{- end }}
{{- end }}

---
# API PostgreSQL Secret
# When using Neon: uses managed connection string
# When using in-cluster: builds URL from components
{{- if .Values.api.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.api.postgresql.name }}-secret
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "taskflow.componentLabels" (dict "root" . "component" "api-db") | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.managedServices.neon.enabled }}
  # Neon managed PostgreSQL
  DATABASE_URL: {{ .Values.managedServices.neon.apiDatabase | quote }}
  {{- else }}
  # In-cluster PostgreSQL
  POSTGRES_PASSWORD: {{ .Values.api.postgresql.password | quote }}
  DATABASE_URL: "postgresql://{{ .Values.api.database.user }}:{{ .Values.api.postgresql.password }}@{{ .Values.api.database.host }}:{{ .Values.api.database.port }}/{{ .Values.api.database.name }}?sslmode=disable"
  {{- end }}
{{- end }}

---
# API Secret
{{- if .Values.api.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.api.name }}-secret
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "taskflow.componentLabels" (dict "root" . "component" "api") | nindent 4 }}
type: Opaque
stringData:
  {{- if not .Values.managedServices.neon.enabled }}
  # Password from values.yaml: api.postgresql.password (only needed for in-cluster)
  DATABASE_PASSWORD: {{ .Values.api.postgresql.password | quote }}
  {{- end }}
  JWT_SECRET: {{ .Values.api.jwtSecret | default "changeme-jwt-secret" | quote }}
  OPENAI_API_KEY: {{ .Values.api.openai.apiKey | default "" | quote }}
  {{- if .Values.managedServices.neon.enabled }}
  # Neon managed PostgreSQL for ChatKit (separate DB for clean microservice boundaries)
  TASKFLOW_CHATKIT_DATABASE_URL: {{ .Values.managedServices.neon.chatkitDatabase | quote }}
  {{- else }}
  # ChatKit uses same DB as API - URL built from api.postgresql.password (SINGLE SOURCE)
  TASKFLOW_CHATKIT_DATABASE_URL: "postgresql://{{ .Values.api.database.user }}:{{ .Values.api.postgresql.password }}@{{ .Values.api.database.host }}:{{ .Values.api.database.port }}/{{ .Values.api.database.name }}?sslmode=disable"
  {{- end }}
{{- end }}

---
# MCP Server Secret (proxy to API - no database access)
{{- if .Values.mcpServer.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.mcpServer.name }}-secret
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "taskflow.componentLabels" (dict "root" . "component" "mcp") | nindent 4 }}
type: Opaque
stringData:
  MCP_API_KEY: {{ .Values.mcpServer.mcpApiKey | default "changeme-mcp-api-key" | quote }}
{{- end }}

---
# Notification Service Secret (separate microservice with own DB)
{{- if .Values.notificationService.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "taskflow.fullname" . }}-notification-secret
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "taskflow.labels" . | nindent 4 }}
    app.kubernetes.io/component: notification-service
type: Opaque
stringData:
  {{- if .Values.managedServices.neon.enabled }}
  # Neon managed PostgreSQL
  notification-database-url: {{ .Values.managedServices.neon.notificationDatabase | quote }}
  {{- else }}
  # In-cluster PostgreSQL
  POSTGRES_PASSWORD: {{ .Values.notificationService.database.password | quote }}
  notification-database-url: "postgresql://{{ .Values.notificationService.database.user }}:{{ .Values.notificationService.database.password }}@{{ .Values.notificationService.database.host }}:{{ .Values.notificationService.database.port }}/{{ .Values.notificationService.database.name }}"
  {{- end }}
{{- end }}
